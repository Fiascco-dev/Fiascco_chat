<!DOCTYPE html>
<html>
<head>
  <title>FIASCCO | Realtime Chat</title>
<link rel="stylesheet" href="/style.css"> 
</head>
<body>
  
  <div id="username-prompt">
      <h1>FIASCCO</h1>
      <h2>Gerçek zamanlı sohbete katılın.</h2>
      <input id="username-input" placeholder="Kullanıcı Adınızı Girin" autofocus />
      <button id="username-submit">Sohbete Başla</button>
  </div>
  
  <ul id="messages"></ul>
  <form id="form" action="">
    <input id="input" autocomplete="off" placeholder="Mesajınızı yazın..." /><button>Gönder</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    let userName = 'Anonim';
    const usernamePrompt = document.getElementById('username-prompt');
    const usernameInput = document.getElementById('username-input');
    const usernameSubmit = document.getElementById('username-submit');
    
    // Bağlantı fix: io() ile tarayıcı adresine bağlanır
    var socket = io(); 
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var messages = document.getElementById('messages');

    // KULLANICI ADI GİRİŞ MANTIĞI
    usernameSubmit.addEventListener('click', function() {
        if (usernameInput.value.trim()) {
            userName = usernameInput.value.trim();
            usernamePrompt.style.display = 'none'; 
            
            // Kullanıcının katıldığını diğerlerine bildir
            socket.emit('chat message', `[Sistem]: ${userName} sohbete katıldı.`);
        }
    });

    // MESAJ GÖNDERME MANTIĞI
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (input.value) {
        // Kullanıcı adını mesajın önüne ekle
        const fullMessage = `[${userName}]: ${input.value}`;
        
        // Mesajı sunucuya gönder
        socket.emit('chat message', fullMessage);
        
        input.value = ''; 
      }
    });

    // MESAJ ALMA MANTIĞI
    socket.on('chat message', function(msg) {
      var item = document.createElement('li');
      
      // Mesajı ayır (Kullanıcı adı kalın olsun diye)
      const parts = msg.match(/^\[(.*?)\]: (.*)$/); 
      if (parts) {
          const user = parts[1];
          const text = parts[2];
          // strong etiketi ile kullanıcı adını kalın yap
          item.innerHTML = `<strong>[${user}]</strong>: ${text}`; 
      } else {
          item.textContent = msg; // Sistem mesajları için
      }

      messages.appendChild(item); 
      window.scrollTo(0, document.body.scrollHeight);
    });
  </script>
</body>
</html>
