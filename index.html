<!DOCTYPE html>
<html>
<head>
  <title>FIASCCO | Realtime Chat</title>
  
  <link rel="stylesheet" href="./style.css"> 
  
</head>
<body>
  
  <div id="username-prompt">
      <h1>FIASCCO</h1>
      <h2>Gerçek zamanlı sohbete katılın.</h2>
      <input id="username-input" placeholder="Kullanıcı Adınızı Girin" autofocus />
      <button id="username-submit">Sohbete Başla</button>
  </div>
  
  <h3 id="online-users" style="color: #4CAF50; text-align: center; margin-top: 10px;">Çevrimiçi: 0</h3>
  
  <ul id="messages"></ul>
  
  <form id="form" action="">
    <input id="input" autocomplete="off" placeholder="Mesajınızı yazın..." /><button>Gönder</button>
  </form>

  <script src="/socket.io/socket.io.js"></script>

  <script>
    let userName = 'Anonim';
    let unreadCount = 0; 
    const originalTitle = document.title; 

    const usernamePrompt = document.getElementById('username-prompt');
    const usernameInput = document.getElementById('username-input');
    const usernameSubmit = document.getElementById('username-submit');
    
    var socket = io(); 
    var form = document.getElementById('form');
    var input = document.getElementById('input');
    var messages = document.getElementById('messages');
    var onlineUsersDisplay = document.getElementById('online-users'); // Online sayaç elemanı

    // Fonksiyon: Başlığı Güncelle (Bildirim Sayacı)
    function updateTitle() {
        if (unreadCount > 0) {
            document.title = `(${unreadCount}) ${originalTitle}`;
        } else {
            document.title = originalTitle;
        }
    }

    // Fonksiyon: Okundu olarak işaretle (Sekmeye tıklandığında)
    function markAsRead() {
        if (unreadCount > 0) {
            unreadCount = 0;
            updateTitle();
        }
    }

    // KULLANICI ADI GİRİŞ MANTIĞI
    usernameSubmit.addEventListener('click', function() {
        if (usernameInput.value.trim()) {
            userName = usernameInput.value.trim();
            usernamePrompt.style.display = 'none'; 
            
            socket.emit('chat message', `[Sistem]: ${userName} sohbete katıldı.`);
        }
    });

    // MESAJ GÖNDERME MANTIĞI
    form.addEventListener('submit', function(e) {
      e.preventDefault();
      if (input.value) {
        const fullMessage = `[${userName}]: ${input.value}`;
        socket.emit('chat message', fullMessage);
        input.value = '';
        
        // Mesaj gönderdiğimizde, sayacı sıfırla
        markAsRead(); 
      }
    });

    // MESAJ ALMA MANTIĞI
    socket.on('chat message', function(msg) {
      var item = document.createElement('li');
      
      const parts = msg.match(/^\[(.*?)\]: (.*)$/); 
      if (parts) {
          const user = parts[1];
          const text = parts[2];
          item.innerHTML = `<strong>[${user}]</strong>: ${text}`; 
      } else {
          item.textContent = msg; 
      }

      messages.appendChild(item); 
      window.scrollTo(0, document.body.scrollHeight);
      
      // Mesajı alan kişi, o anda sayfaya bakmıyorsa sayacı artır
      if (document.hidden) {
          unreadCount++;
          updateTitle();
      }
    });

    // YENİ: Online kullanıcı sayacı mantığı
    socket.on('online_count', function(count) {
      onlineUsersDisplay.textContent = `Çevrimiçi: ${count}`;
    });

    // Tarayıcı sekmesine geri dönüldüğünde sayacı sıfırlama olay dinleyicisi
    document.addEventListener('visibilitychange', markAsRead);
  </script>
</body>
</html>
